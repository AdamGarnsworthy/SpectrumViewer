<html>

	<head>
		<script src="gammaSpectrum.js" type="text/javascript"></script>
		<script src="fitit.js" type="text/javascript"></script>
		<script src="spectrumViewer.js" type="text/javascript"></script>
		<script src="http://code.createjs.com/easeljs-0.7.0.min.js"></script>

		<link rel="stylesheet" type="text/css" href="spectrumViewer.css"/>
		<link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
	</head>

	<body onLoad='populateSpectra()'>
		<div id='wrapper'>

		    <div id='branding'>
		    	<img id='logo' src='logo.gif'></img>
		    	<h1 id='headerBanner'>GRIFFIN</h1>
		    </div>

		    <div id='navigation'>
		    	<button id='statusButton' class='navButton'>MIDAS Status</button>
		    </div>

		    
	    	<div id='canvasWrap'>
	    		<canvas id='spectrumCanvas'></canvas>
	    		<form id='plotControl'>
		    		<div id='xRangeWrap', class='UIchunk'>
			    		<input class='inputBox' id='minX' type='number' value='0' onchange='updatePlotRange()'></input>
			    		<label class='inputLabel' id='xRangeLabel'>< x <</label>
		    			<input class='inputBox' id='maxX' type='number' value='2048' onchange='updatePlotRange()'></input>
		    		</div>

		    		<div id='scrollWrap', class='UIchunk'>
		    			<button class='inputButton' id='bigLeft' type='button'>&#x21C7</button>
		    			<button class='inputButton' id='littleLeft' type='button'>&#x2190</button>
		    			<button class='inputButton' id='littleRight' type='button'>&#x2192</button>
		    			<button class='inputButton' id='bigRight' type='button'>&#x21C9</button>
		    		</div>

			    	<div id='fitModeToggle' engaged='0'>
			    		Fit Mode
			    	</div>

			    	<button class='inputButton' id='unzoom' type='button'>Unzoom</button>

			    	<div id='logToggleWrap' class='UIchunk'>
			    		<label class='inputLabel' id='linLabel'>Linear</label>
			    		<label class='inputLabel' id='logLabel'>Log</label>
			    	</div>

			    	<button class='inputButton' id='waveformSnap' type='button' engaged='0'>Snap to Waveform</button>

			    	<div id='updateWrap' class='UIchunk'>
				    	<label id='updateLabel' class='inputLabel'>Update Every: </label>
				    	<select id='upOptions'>
				    		<option value='3000'>3 s</option>
				    		<option value='5000'>5 s</option>
				    		<option value='10000'>10 s</option>
				    		<option value='-1'>never</option>
				    	</select>
				    	<button id='upNow' class='inputButton' type='button'>Update Now</button>
				    </div>
		    	</form>

	    	</div>

	    	<div id='sidebarWrap'>
	    		<ul id='availableSpectra'></ul>

	    	</div>

		    <div id='recentSpectra'>
		 		<div id='titleRow' class='recentWrap'>
		 			<div id='spectraList'>Spectra</div>
		 			<div id='fitTarget'>Fit Target</div>
		 			<div id='fitResults' class='fitResults'>Fit Results</div>
		 			<div id='killAllLabel'>Delete All</div>
		 			<div id='killAll' class='killSwitch'>&#x2573</div>
		 		</div>

		    </div>
		    
		    <div id='bumperDiv'></div>

		</div>

		<div id='footer'>
			Spectrum Viewer - GRIFFIN Collaboration 2013 
		</div>

		<script>
			//initialize a global buffer for all the histograms we pull in:
			spectrumBuffer = {};

			function main(){

				//scrape the URL for a query string
				queryString();

				//inject the linear / log toggle
				toggleSwitch('logToggleWrap', 'toggleYscale', '', '', '', viewer.setAxisType.bind(viewer, 'log'), viewer.setAxisType.bind(viewer, 'linear'), 0);
				document.getElementById('logToggleWrap').insertBefore(document.getElementById('logLabel'), null);

				//callback after drawing spectrum
				viewer.drawCallback = function(){
					var xMin = document.getElementById('minX'),
						xMax = document.getElementById('maxX');

					//keep the x-range input up to date
					xMin.value = this.XaxisLimitMin;
					xMax.value = this.XaxisLimitMax;
				}

				//onclick for scroll buttons:
				document.getElementById('bigLeft').onclick = viewer.scrollSpectra.bind(viewer, -100);
				document.getElementById('littleLeft').onclick = viewer.scrollSpectra.bind(viewer, -1);
				document.getElementById('littleRight').onclick = viewer.scrollSpectra.bind(viewer, 1);
				document.getElementById('bigRight').onclick = viewer.scrollSpectra.bind(viewer, 100);

				//unzoom
				document.getElementById('unzoom').onclick = viewer.unzoom.bind(viewer);

				//fit mode
				document.getElementById('fitModeToggle').onclick = function(){
					if(this.engaged){
						this.style.backgroundColor = '#444444';
						viewer.leaveFitMode();
						this.engaged = 0;
					} else {
						this.style.backgroundColor = '#777777';
						viewer.setupFitMode();
						this.engaged = 1; 
					}
				}
				viewer.fitCallback = function(mean, width){
					fitCallback(mean, width);
					document.getElementById('fitModeToggle').onclick();
				}

				//waveform snap
				document.getElementById('waveformSnap').onclick = function(){
					if(this.engaged){
						this.style.backgroundColor = '#444444';
						viewer.demandXmin = null;
						viewer.demandXmax = null;
						viewer.demandYmin = null;
						viewer.demandYmax = null;
						viewer.unzoom();
						this.engaged = 0;
					} else {
						this.style.backgroundColor = '#777777';
						viewer.demandXmin = 0;
						viewer.demandXmax = 256;
						viewer.demandYmin = 1500;
						viewer.demandYmax = 2500;
						viewer.plotData();
						this.engaged = 1; 
					}					
				}

				//update now
				document.getElementById('upNow').onclick = function(){
					var refreshOptions = document.getElementById('upOptions'),
						refreshTime = parseInt(refreshOptions.options[refreshOptions.selectedIndex].value, 10);

					clearInterval(refreshCycle);
					refreshSpectra();
					if(refreshTime != -1)
						refreshCycle = setInterval(refreshSpectra, refreshTime);					
				}
				//onchange refresh time
				document.getElementById('upOptions').onchange = function(){
					var refreshTime = parseInt(this.options[this.selectedIndex].value, 10);
					clearInterval(refreshCycle);
					refreshSpectra();
					if(refreshTime != -1)
						refreshCycle = setInterval(refreshSpectra, refreshTime);	
				}

				//recently viewed header row
				toggleSwitch('titleRow', 'toggleAll', 'x', 'Show All', 'Hide All', toggleAll.bind(null, true), toggleAll.bind(null, false), 1);
				document.getElementById('titleRow').insertBefore(document.getElementById('toggleWraptoggleAll'), document.getElementById('fitTarget'));

				//killAll button
				document.getElementById('killAll').onclick = function(){
					var key;

					for(key in viewer.plotBuffer){
						document.getElementById('kill'+key).onclick();
					}
				}

				//initially populate with whatever's requested from the query string, if anything
				if(queryVars.spectrum && document.getElementById(queryVars.spectrum))
					document.getElementById(queryVars.spectrum).onclick();

				//re-fetch every period:
				refreshSpectra();
				refreshCycle = setInterval(refreshSpectra, 3000);

			};

			//update the plot ranges onchange of the x-range input fields:
			function updatePlotRange(){
				var xMin = document.getElementById('minX'),
					xMax = document.getElementById('maxX');

				viewer.XaxisLimitMin = parseInt(xMin.value,10);
				viewer.XaxisLimitMax = parseInt(xMax.value,10);

				viewer.plotData();				
			};

			//show / hide all toggle
			function toggleAll(show){
				var key;

				for(key in viewer.plotBuffer){
					setToggle('toggleSwitchtoggle'+key, show);
				}
			};

		</script>
	</body>

</html>